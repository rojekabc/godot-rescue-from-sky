[gd_scene load_steps=6 format=2]

[ext_resource path="res://Resources/ArmyMaterial.shader" type="Shader" id=1]
[ext_resource path="res://Resources/Army20.png" type="Texture" id=2]

[sub_resource type="GDScript" id=1]
resource_name = "Army"
script/source = "extends Area2D

var Moveable
var Destructable : Destructable
var ownerIdx

signal object_destroyed(object)

var dc = false

var tween
var id

# 1. army was attacking structure
# 2. catch transport and stop it
# 3. was attacked by enemy
# 4. wins and find other target
# 5. tarnsport don't move any more and wasn't destroyed

func _ready():
	if get_parent().get_name() == 'Templates':
		return
	# resolve Tween
	tween = Game.getWorld().get_node(\"Tween\")

func target_destroyed(target):
	Game.verbose(get_name() + ': Target destroyed')
	find_new_target()

func get_name():
	return Game.playerDefinitions[ownerIdx].name + \".army.\" + str(id)

func destroy():
	Game.verbose(get_name() + \": Destroy\")
	emit_signal('object_destroyed', self)
	tween.remove(self, \"position\")
	# Game.getWorld().get_node('Map/Armies').remove(self)
	queue_free()

func reset_rotation():
	$Sprite.rotation_degrees = Moveable.get_rotation_degrees()

func assign_target(target):
	Moveable.assign_target(target)
	reset_rotation()

func get_target() -> Area2D:
	return Moveable.target
	
func get_hp_rate() -> float:
	return Destructable.get_hp_rate()

func find_new_target():
	var target = Game.getWorld().army_find_target(self)
	if target == null:
		return
	# setup new target
	assign_target(target)
	# start moving to the target
	Game.getWorld()._calculate_move_tween(self)

"

[sub_resource type="ShaderMaterial" id=2]
shader = ExtResource( 1 )
shader_param/color = Plane( 1, 0, 0, 1 )

[sub_resource type="RectangleShape2D" id=3]
extents = Vector2( 15, 15 )

[node name="Army" type="Area2D" groups=[
"Army",
]]
script = SubResource( 1 )
__meta__ = {
"_edit_group_": true
}

[node name="Sprite" type="Sprite" parent="."]
material = SubResource( 2 )
texture = ExtResource( 2 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
visible = false
shape = SubResource( 3 )

