[gd_scene load_steps=16 format=2]

[ext_resource path="res://Objects/GameWorld.gd" type="Script" id=1]
[ext_resource path="res://Objects/BorderScanner.gd" type="Script" id=2]
[ext_resource path="res://Objects/OwnerMap.gd" type="Script" id=3]
[ext_resource path="res://Objects/ResourceDistribution.gd" type="Script" id=4]
[ext_resource path="res://Objects/RuleOfWin.gd" type="Script" id=5]
[ext_resource path="res://Resources/PanelStyle.tres" type="StyleBox" id=6]
[ext_resource path="res://Resources/TitleStyle.tres" type="StyleBox" id=7]
[ext_resource path="res://Resources/TitleFont.tres" type="DynamicFont" id=8]
[ext_resource path="res://Resources/LabelFont.tres" type="DynamicFont" id=9]
[ext_resource path="res://Resources/StatusFont.tres" type="DynamicFont" id=10]
[ext_resource path="res://Objects/StatusLabel.gd" type="Script" id=11]
[ext_resource path="res://Resources/Grundschrift-Light.otf" type="DynamicFontData" id=12]
[ext_resource path="res://Scenes/Button.gd" type="Script" id=13]

[sub_resource type="GDScript" id=1]
resource_name = "UISquad"
script/source = "extends PanelContainer

var airport = null

func _ready():
	$Container/Columns/Actions/Target.connect('pressed', self, '_target_pressed')
	$Container/Title.connect('gui_input', self, '_title_gui_input')
	pass

func _title_gui_input(event):
	if event is InputEventMouseButton and event.is_pressed():
		$Container/Title.accept_event()
		clear_planes()
		_detach_airport_view()

func _target_pressed():
	var planes = _list_selected_planes()
	if planes.empty():
		Game.getWorld()._info('Select any plane')
		return
	Game.getWorld().select_target(airport, planes)
	_detach_airport_view()
	pass

func _detach_airport_view():
	airport.disconnect('update_planes', self, '_sig_update_planes')
	hide()
	airport = null
	return 0

func _attach_airport_view(airport):
	show()
	self.airport = airport
	airport.connect('update_planes', self, '_sig_update_planes')
	return 0

func _sig_update_planes(object, planes):
	update_planes()
	pass

func _list_selected_planes():
	var result = []
	for checkbox in $Container/Columns/Planes/Container.get_children():
		if checkbox.pressed:
			result.append(checkbox.get_meta('plane'))
	return result

func update_planes():
	if airport == null:
		return
	var planes = airport.PlaneHolder.planes.duplicate()
	for child in $Container/Columns/Planes/Container.get_children():
		var uiplane = child.get_meta('plane')
		if airport.PlaneHolder.planes.has(uiplane):
			planes.erase(uiplane)
		else:
			$Container/Columns/Planes/Container.remove_child(child)
			child.queue_free()
	for plane in planes:
		append_plane(plane)

func clear_planes():
	for child in $Container/Columns/Planes/Container.get_children():
		$Container/Columns/Planes/Container.remove_child(child)
		child.queue_free()

func append_plane(plane):
	var checkbox = CheckBox.new()
	if plane.type == Game.PLANE.FIGHTER:
		checkbox.text = 'Fighter'
	else:
		checkbox.text = 'Bomber'
	checkbox.set_meta('plane', plane)
	$Container/Columns/Planes/Container.add_child(checkbox)

func append_planes(planesData):
	for plane in planesData:
		append_plane(plane)

func set_airport(airport):
	clear_planes()
	if self.airport == airport:
		return _detach_airport_view()
	else:
		if self.airport != null:
			_detach_airport_view()
		_attach_airport_view(airport)
	append_planes(self.airport.PlaneHolder.planes)
	pass
"

[sub_resource type="DynamicFont" id=2]
size = 64
outline_size = 2
outline_color = Color( 0, 0, 0, 1 )
font_data = ExtResource( 12 )

[node name="World" type="Node2D"]
script = ExtResource( 1 )

[node name="Map" type="Node2D" parent="."]

[node name="Structures" type="Node2D" parent="Map"]

[node name="Borders" type="Node2D" parent="Map"]

[node name="Transports" type="Node2D" parent="Map"]

[node name="Armies" type="Node2D" parent="Map"]

[node name="Squads" type="Node2D" parent="Map"]

[node name="BorderScanner" type="Node" parent="Map"]
script = ExtResource( 2 )

[node name="OwnerMap" type="Node" parent="Map"]
script = ExtResource( 3 )

[node name="ResourceDistribution" type="Node" parent="Map"]
script = ExtResource( 4 )

[node name="RuleOfWin" type="Node" parent="Map"]
script = ExtResource( 5 )

[node name="UI" type="Control" parent="."]
margin_right = 1024.0
margin_bottom = 600.0

[node name="Suqad" type="PanelContainer" parent="UI"]
editor/display_folded = true
visible = false
margin_left = 377.0
margin_top = 180.0
margin_right = 643.0
margin_bottom = 449.0
custom_styles/panel = ExtResource( 6 )
script = SubResource( 1 )
__meta__ = {
"_edit_group_": true
}

[node name="Container" type="VBoxContainer" parent="UI/Suqad"]
margin_left = 10.0
margin_top = 10.0
margin_right = 256.0
margin_bottom = 259.0

[node name="Title" type="Label" parent="UI/Suqad/Container"]
margin_right = 246.0
margin_bottom = 45.0
mouse_filter = 1
custom_styles/normal = ExtResource( 7 )
custom_fonts/font = ExtResource( 8 )
text = "Squad"
align = 1

[node name="Columns" type="HBoxContainer" parent="UI/Suqad/Container"]
margin_top = 49.0
margin_right = 246.0
margin_bottom = 249.0

[node name="Planes" type="ScrollContainer" parent="UI/Suqad/Container/Columns"]
margin_right = 171.0
margin_bottom = 200.0
rect_min_size = Vector2( 150, 200 )
size_flags_horizontal = 3

[node name="Container" type="VBoxContainer" parent="UI/Suqad/Container/Columns/Planes"]
margin_right = 171.0
size_flags_horizontal = 3

[node name="Actions" type="VBoxContainer" parent="UI/Suqad/Container/Columns"]
margin_left = 175.0
margin_right = 246.0
margin_bottom = 200.0

[node name="Target" type="Button" parent="UI/Suqad/Container/Columns/Actions"]
margin_right = 71.0
margin_bottom = 33.0
custom_fonts/font = ExtResource( 9 )
text = "Target"

[node name="Patrol" type="Button" parent="UI/Suqad/Container/Columns/Actions"]
visible = false
margin_top = 37.0
margin_right = 71.0
margin_bottom = 70.0
custom_fonts/font = ExtResource( 9 )
text = "Patrol"

[node name="Status" type="Label" parent="UI"]
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
margin_left = -1.0
margin_top = -42.0
margin_right = -1.0
margin_bottom = -2.0
size_flags_horizontal = 3
custom_fonts/font = ExtResource( 10 )
text = "Status message"
align = 1
script = ExtResource( 11 )

[node name="EndGame" type="VBoxContainer" parent="UI"]
visible = false
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
margin_left = -119.5
margin_top = -57.5
margin_right = 119.5
margin_bottom = 57.5

[node name="Status" type="Label" parent="UI/EndGame"]
margin_right = 239.0
margin_bottom = 78.0
custom_fonts/font = SubResource( 2 )
text = "You Win!"
script = ExtResource( 11 )
show_duration = 6

[node name="Button" type="Button" parent="UI/EndGame"]
margin_top = 82.0
margin_right = 239.0
margin_bottom = 115.0
custom_fonts/font = ExtResource( 9 )
text = "End Game"
script = ExtResource( 13 )

[node name="Timer" type="Timer" parent="."]
autostart = true

[node name="Tween" type="Tween" parent="."]
