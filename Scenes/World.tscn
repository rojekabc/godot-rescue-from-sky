[gd_scene load_steps=11 format=2]

[ext_resource path="res://Objects/GameWorld.gd" type="Script" id=1]
[ext_resource path="res://Resources/PanelStyle.tres" type="StyleBox" id=2]
[ext_resource path="res://Resources/TitleStyle.tres" type="StyleBox" id=3]
[ext_resource path="res://Resources/TitleFont.tres" type="DynamicFont" id=4]
[ext_resource path="res://Resources/LabelFont.tres" type="DynamicFont" id=5]
[ext_resource path="res://Objects/BorderScanner.gd" type="Script" id=6]
[ext_resource path="res://Objects/OwnerMap.gd" type="Script" id=7]
[ext_resource path="res://Objects/ResourceDistribution.gd" type="Script" id=8]

[sub_resource type="GDScript" id=1]
resource_name = "UISquad"
script/source = "extends PanelContainer

var airport = null

func _ready():
	$Container/Columns/Actions/Target.connect('pressed', self, '_target_pressed')
	$Container/Title.connect('gui_input', self, '_title_gui_input')
	pass

func _title_gui_input(event):
	if event is InputEventMouseButton and event.is_pressed():
		$Container/Title.accept_event()
		clear_planes()
		_detach_airport_view()

func _target_pressed():
	var planes = _list_selected_planes()
	if planes.empty():
		Game.getWorld()._info('Select any plane')
		return
	Game.getWorld().select_target(airport, planes)
	_detach_airport_view()
	pass

func _detach_airport_view():
	airport.disconnect('update_planes', self, '_sig_update_planes')
	hide()
	airport = null
	return 0

func _attach_airport_view(airport):
	show()
	self.airport = airport
	airport.connect('update_planes', self, '_sig_update_planes')
	return 0

func _sig_update_planes(object, planes):
	update_planes()
	pass

func _list_selected_planes():
	var result = []
	for checkbox in $Container/Columns/Planes/Container.get_children():
		if checkbox.pressed:
			result.append(checkbox.get_meta('plane'))
	return result

func update_planes():
	if airport == null:
		return
	var planes = airport.PlaneHolder.planes.duplicate()
	for child in $Container/Columns/Planes/Container.get_children():
		var uiplane = child.get_meta('plane')
		if airport.PlaneHolder.planes.has(uiplane):
			planes.erase(uiplane)
		else:
			$Container/Columns/Planes/Container.remove_child(child)
			child.queue_free()
	for plane in planes:
		append_plane(plane)

func clear_planes():
	for child in $Container/Columns/Planes/Container.get_children():
		$Container/Columns/Planes/Container.remove_child(child)
		child.queue_free()

func append_plane(plane):
	var checkbox = CheckBox.new()
	if plane.type == Game.PLANE.FIGHTER:
		checkbox.text = 'Fighter'
	else:
		checkbox.text = 'Bomber'
	checkbox.set_meta('plane', plane)
	$Container/Columns/Planes/Container.add_child(checkbox)

func append_planes(planesData):
	for plane in planesData:
		append_plane(plane)

func set_airport(airport):
	clear_planes()
	if self.airport == airport:
		return _detach_airport_view()
	else:
		if self.airport != null:
			_detach_airport_view()
		_attach_airport_view(airport)
	append_planes(self.airport.PlaneHolder.planes)
	pass
"

[sub_resource type="GDScript" id=2]
resource_name = "Status"
script/source = "extends Label

var startTick

const STATUS_COLOR = Color(1, 1, 1, 0.6)
const INFO_COLOR = Color(0, 1, 1, 0.6)
const FAIL_COLOR = Color(1, 0, 0, 0.6)

func _ready():
	Game.getTimer().connect('timeout', self, '_timeout')
	pass
	
func _timeout():
	if visible and Game.timetick > startTick + 2:
		visible = false
	pass

func _status(msg, color):
	text = msg
	modulate = color
	visible = true
	startTick = Game.timetick
	

func status(msg):
	_status(msg, STATUS_COLOR)
	pass

func info(msg):
	_status(msg, INFO_COLOR)

func fail(msg):
	_status(msg, FAIL_COLOR)
"

[node name="World" type="Node2D"]
script = ExtResource( 1 )

[node name="Map" type="Node2D" parent="."]

[node name="Structures" type="Node2D" parent="Map"]

[node name="Borders" type="Node2D" parent="Map"]

[node name="Transports" type="Node2D" parent="Map"]

[node name="Armies" type="Node2D" parent="Map"]

[node name="Squads" type="Node2D" parent="Map"]

[node name="UI" type="Control" parent="Map"]
margin_right = 1024.0
margin_bottom = 600.0

[node name="Suqad" type="PanelContainer" parent="Map/UI"]
editor/display_folded = true
margin_left = 377.0
margin_top = 180.0
margin_right = 643.0
margin_bottom = 449.0
custom_styles/panel = ExtResource( 2 )
script = SubResource( 1 )
__meta__ = {
"_edit_group_": true
}

[node name="Container" type="VBoxContainer" parent="Map/UI/Suqad"]
margin_left = 10.0
margin_top = 10.0
margin_right = 256.0
margin_bottom = 259.0

[node name="Title" type="Label" parent="Map/UI/Suqad/Container"]
margin_right = 246.0
margin_bottom = 45.0
mouse_filter = 1
custom_styles/normal = ExtResource( 3 )
custom_fonts/font = ExtResource( 4 )
text = "Squad"
align = 1

[node name="Columns" type="HBoxContainer" parent="Map/UI/Suqad/Container"]
margin_top = 49.0
margin_right = 246.0
margin_bottom = 249.0

[node name="Planes" type="ScrollContainer" parent="Map/UI/Suqad/Container/Columns"]
margin_right = 171.0
margin_bottom = 200.0
rect_min_size = Vector2( 150, 200 )
size_flags_horizontal = 3

[node name="Container" type="VBoxContainer" parent="Map/UI/Suqad/Container/Columns/Planes"]
margin_right = 171.0
size_flags_horizontal = 3

[node name="Actions" type="VBoxContainer" parent="Map/UI/Suqad/Container/Columns"]
margin_left = 175.0
margin_right = 246.0
margin_bottom = 200.0

[node name="Target" type="Button" parent="Map/UI/Suqad/Container/Columns/Actions"]
margin_right = 71.0
margin_bottom = 33.0
custom_fonts/font = ExtResource( 5 )
text = "Target"

[node name="Patrol" type="Button" parent="Map/UI/Suqad/Container/Columns/Actions"]
visible = false
margin_top = 37.0
margin_right = 71.0
margin_bottom = 70.0
custom_fonts/font = ExtResource( 5 )
text = "Patrol"

[node name="Status" type="Label" parent="Map/UI"]
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
margin_left = -1.0
margin_top = -42.0
margin_right = -1.0
margin_bottom = -2.0
size_flags_horizontal = 3
custom_fonts/font = ExtResource( 5 )
text = "Status message"
align = 1
script = SubResource( 2 )

[node name="Label" type="Label" parent="Map/UI"]
anchor_right = 1.0
margin_left = 857.0
margin_bottom = 15.0
grow_horizontal = 0
text = " v1.1.0 \"Armies go to war\""

[node name="BorderScanner" type="Node" parent="Map"]
script = ExtResource( 6 )

[node name="OwnerMap" type="Node" parent="Map"]
script = ExtResource( 7 )

[node name="ResourceDistribution" type="Node" parent="Map"]
script = ExtResource( 8 )

[node name="Timer" type="Timer" parent="."]
autostart = true

[node name="Tween" type="Tween" parent="."]

